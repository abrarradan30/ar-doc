@php
$req = app()->request;
$helper = getCore('Helper');
$date_now = date('d/m/Y H:i:s');

// ================= EXPORT HANDLING =================
$exportParam = strtolower((string)($req->get('export') ?? ''));
$isExcelExport = in_array($exportParam, ['xls','xlsx','excel','csv'], true);

$fmtBrowser = function ($v) {
    $v = (float)($v ?? 0);
    $neg = $v < 0;
    $abs = (int)abs($v);
    $s = 'Rp ' . number_format($abs, 0, ',', '.');
    return $neg ? "({$s})" : $s;
};

$fmtExportPlain = fn ($v) => (int)round((float)($v ?? 0));
$cellNumberStyle = "mso-number-format:'\\0022Rp\\0022 #,##0';";

// ================= FILTER =================
$customerId = $req->get('customer_id');

// ==================================================
// 1️⃣ AGG NON-TRADING SI (POST + DRAFT)
// ==================================================
$aggSid = \DB::table('t_sales_invoice as si')
    ->join('t_sales_invoice_d as sid', 'sid.t_sales_invoice_id', '=', 'si.id')
    ->select(
        'si.t_sales_order_id',
        \DB::raw('SUM(sid.berat_si) as total_berat_si_sid')
    )
    ->whereIn('si.status', ['POST', 'DRAFT'])
    ->groupBy('si.t_sales_order_id');

// ==================================================
// 2️⃣ AGG TRADING SI (POST + DRAFT)
// ==================================================
$aggSitd = \DB::table('t_sales_invoice as si')
    ->join('t_sales_invoice_trading_d as sitd', 'sitd.t_sales_invoice_id', '=', 'si.id')
    ->select(
        'si.t_sales_order_id',
        \DB::raw('SUM(sitd.berat_si) as total_berat_si_sitd')
    )
    ->whereIn('si.status', ['POST', 'DRAFT'])
    ->groupBy('si.t_sales_order_id');

// ===================================================================
// 3️⃣ AGG SURAT JALAN BELUM MASUK SI (POST / DRAFT)
// ===================================================================
$aggSjOutstanding = \DB::table('t_surat_jalan as sj')
    ->select(
        'sj.t_sales_order_id',
        \DB::raw('SUM(sj.berat_kirim) as total_berat_sj_outstanding')
    )
    ->whereIn('sj.status', ['POST', 'DRAFT'])
    ->whereNotExists(function ($q) {
        $q->select(\DB::raw(1))
          ->from('t_sales_invoice_d as sid')
          ->join('t_sales_invoice as si', 'si.id', '=', 'sid.t_sales_invoice_id')
          ->whereColumn('sid.t_surat_jalan_id', 'sj.id')
          ->whereIn('si.status', ['POST', 'DRAFT']);
    })
    ->groupBy('sj.t_sales_order_id');

// ==================================================
// 4️⃣ TOTAL BERAT KIRIM (FINAL)
// ==================================================
$aggBeratKirim = \DB::table('t_sales_order as so')
    ->leftJoinSub($aggSid, 'agg_sid', fn ($j) => $j->on('agg_sid.t_sales_order_id', '=', 'so.id'))
    ->leftJoinSub($aggSitd, 'agg_sitd', fn ($j) => $j->on('agg_sitd.t_sales_order_id', '=', 'so.id'))
    ->leftJoinSub($aggSjOutstanding, 'agg_sj', fn ($j) => $j->on('agg_sj.t_sales_order_id', '=', 'so.id'))
    ->select(
        'so.id as t_sales_order_id',
        \DB::raw('
            COALESCE(agg_sid.total_berat_si_sid,0)
          + COALESCE(agg_sitd.total_berat_si_sitd,0)
          + COALESCE(agg_sj.total_berat_sj_outstanding,0)
          AS total_berat_kirim
        ')
    );

// ==================================================
// 5️⃣ INVOICE TERAKHIR (POST ATAU DRAFT)
// ==================================================
$lastInvoice = \DB::table('t_sales_invoice as si')
    ->select(
        'si.t_sales_order_id',
        \DB::raw('MAX(si.id) as last_invoice_id')
    )
    ->whereIn('si.status', ['POST', 'DRAFT'])
    ->groupBy('si.t_sales_order_id');

// ==================================================
// 6️⃣ QUERY UTAMA LAPORAN
// ==================================================
$data = \DB::table('t_sales_order as so')
    ->leftJoin('m_customer as cust', 'so.m_customer_id', '=', 'cust.id')
    ->leftJoin('m_item as item', 'so.m_item_id', '=', 'item.id')
    ->leftJoinSub($aggBeratKirim, 'agg_kirim', fn ($j) => $j->on('agg_kirim.t_sales_order_id','=','so.id'))
    ->leftJoinSub($lastInvoice, 'li', fn ($j) => $j->on('li.t_sales_order_id','=','so.id'))
    ->leftJoin('t_sales_invoice as si_last', 'si_last.id', '=', 'li.last_invoice_id')
    ->select(
        'so.id',
        'so.no_so',
        'so.tgl as tanggal_so',
        'so.no_po_customer',
        'so.berat as berat_so',
        'so.harga',
        'so.penerima',
        'cust.nama as customer_nama',
        'item.nama_item',

        \DB::raw('COALESCE(agg_kirim.total_berat_kirim,0) as berat_kirim'),
        \DB::raw('GREATEST(COALESCE(so.berat,0) - COALESCE(agg_kirim.total_berat_kirim,0),0) as sisa_so'),

        \DB::raw("(
            CASE 
                /* Jika ada history yang mengunci saldo negatif (pelunasan), sisa DP paksa 0 */
                WHEN EXISTS(
                    SELECT 1 FROM t_sales_order_h h
                    WHERE h.t_sales_order_id = so.id
                    AND h.is_kunci = true
                    AND h.dp < 0
                ) THEN 0
                
                /* Ambil sisa_dp dari invoice terakhir jika sudah ada invoice (DRAFT/POST) */
                WHEN si_last.id IS NOT NULL THEN COALESCE(si_last.sisa_dp, 0)
                
                /* JIKA BELUM ADA INVOICE: Hitung SUM DP dari History (Termasuk status DRAFT/PROCESS) */
                ELSE COALESCE(
                    (
                        SELECT GREATEST(SUM(h.dp), 0)
                        FROM t_sales_order_h h
                        WHERE h.t_sales_order_id = so.id
                        AND h.is_kunci = true
                        /* Menghapus filter is_status = true agar DRAFT tetap terhitung jika is_kunci sudah set */
                    ), 
                    0
                )
            END
        ) as sisa_dp")
    )
    ->where('so.status_transaksi', 'PROCESS')
    ->when($customerId, fn ($q) => $q->where('cust.id', $customerId))
    ->when($req->periode_from, fn ($q) => $q->whereDate('so.tgl','>=',date('Y-m-d',strtotime($req->periode_from))))
    ->when($req->periode_to, fn ($q) => $q->whereDate('so.tgl','<=',date('Y-m-d',strtotime($req->periode_to))))
    ->orderBy('so.id', $req->sort_id == 'terbesar_id' ? 'desc' : 'asc')
    ->get();
@endphp

<div style="text-align: center;">
  <h1 style="font-size: 14px; font-weight: bold;">Laporan Sales Order Outstanding</h1>
  <p style="font-size: 10px;"> Periode : {{@$req->periode_from ? $helper->formatDateId(@$req->periode_from) : '-'}} {{@$req->periode_to ? '- ' . $helper->formatDateId(@$req->periode_to) : ''}}</p>
</div>

<table style="border: 1px solid black; border-collapse: collapse; font-size: 9px; width: 100%;">
  <thead>
    <tr style="background-color: #f2f2f2; font-weight: bold; text-align: center;">
      <th style="border: 1px solid black; text-align: center; vertical-align: middle;">No</th>
      <th style="border: 1px solid black; text-align: center; vertical-align: middle;">Tanggal</th>
      <th style="border: 1px solid black; text-align: center; vertical-align: middle;">No SO</th>
      <th style="border: 1px solid black; text-align: center; vertical-align: middle;">Nama Customer</th>
      <th style="border: 1px solid black; text-align: center; vertical-align: middle;">KA (%)</th>
      <th style="border: 1px solid black; text-align: center; vertical-align: middle;">Harga</th>
      <th style="border: 1px solid black; text-align: center; vertical-align: middle;">Berat SO</th>
      <th style="border: 1px solid black; text-align: center; vertical-align: middle;">Berat Kirim</th>
      <th style="border: 1px solid black; text-align: center; vertical-align: middle;">Sisa SO</th>
      <th style="border: 1px solid black; text-align: center; vertical-align: middle;">Sisa DP</th>
      <th style="border: 1px solid black; text-align: center; vertical-align: middle;">Penerima</th>
    </tr>
  </thead>
  <tbody>
    @if(request()->filled('so_id') && $data->isEmpty())
      <tr>
        <td colspan="11" style="text-align: center; font-style: italic;">No data to show!</td>
      </tr>
    @elseif($data->isEmpty())
      <tr>
        <td colspan="11" style="text-align: center; font-style: italic;">Silakan pilih filter untuk melihat data.</td>
      </tr>
    @else
      @foreach ($data as $index => $row)
      <tr>
        <td style="border: 1px solid black; text-align: center; vertical-align: middle;">{{ $index + 1 }}</td>
        <td style="border: 1px solid black; text-align: center; vertical-align: middle;">
          {{ \Carbon\Carbon::parse($row->tanggal_so)->format('d/m/Y') }}
        </td>
        <td style="border: 1px solid black; text-align: center; vertical-align: middle;">{{ $row->no_so }}</td>
        <td style="border: 1px solid black; text-align: center; vertical-align: middle;">{{ $row->customer_nama ?? '-' }}</td>
        <td style="border: 1px solid black; text-align: center; vertical-align: middle;">{{ $row->nama_item ?? '-' }}</td>
        <td style="border:1px solid #000;text-align:right;vertical-align:middle;padding-right:3px;{{ $isExcelExport ? $cellNumberStyle : '' }}">
          {{ $isExcelExport ? $fmtExportPlain($row->harga ?? 0) : $fmtBrowser($row->harga ?? 0) }}
        </td>

        <td style="border:1px solid #000;text-align:right;vertical-align:middle;padding-right:3px;{{ $isExcelExport ? $cellNumberStyle : '' }}">
          {{ $isExcelExport ? $fmtExportPlain($row->berat_so ?? 0) : number_format((float)($row->berat_so ?? 0), 0, ',', '.') }}
        </td>

        <td style="border:1px solid #000;text-align:right;vertical-align:middle;padding-right:3px;{{ $isExcelExport ? $cellNumberStyle : '' }}">
          {{ $isExcelExport ? $fmtExportPlain($row->berat_kirim ?? 0) : number_format((float)($row->berat_kirim ?? 0), 0, ',', '.') }}
        </td>

        <td style="border:1px solid #000;text-align:right;vertical-align:middle;padding-right:3px;{{ $isExcelExport ? $cellNumberStyle : '' }}">
          {{ $isExcelExport ? $fmtExportPlain($row->sisa_so ?? 0) : number_format((float)($row->sisa_so ?? 0), 0, ',', '.') }}
        </td>

        <td style="border:1px solid #000;text-align:right;vertical-align:middle;padding-right:3px;{{ $isExcelExport ? $cellNumberStyle : '' }}">
          {{ $isExcelExport ? $fmtExportPlain($row->sisa_dp ?? 0) : $fmtBrowser($row->sisa_dp ?? 0) }}
        </td>
        <td style="border: 1px solid black; text-align: center; vertical-align: middle;">{{ $row->penerima ?? '-' }}</td>
      </tr>
      @endforeach
    @endif
  </tbody>
</table>