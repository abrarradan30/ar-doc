@php
use Illuminate\Support\Facades\DB;

$req    = app()->request;
$helper = getCore('Helper');

/* ================= EXPORT ================= */
$exportParam   = strtolower((string)($req->get('export') ?? ''));
$isExcelExport = in_array($exportParam, ['xls','xlsx','excel','csv'], true);

$fmtBrowser     = fn($v) => number_format((float)($v ?? 0), 0, ',', '.');
$fmtExportPlain = fn($v) => (int)round((float)($v ?? 0));
$cellNumberStyle = "mso-number-format:'\\0022Rp\\0022 #,##0';";

/* ================= PERIODE ================= */
$periodeFrom = $req->get('periode_from') ? date('Y-m-d', strtotime($req->get('periode_from'))) : null;
$periodeTo   = $req->get('periode_to')   ? date('Y-m-d', strtotime($req->get('periode_to')))   : null;

/* =========================================================
   STEP 1ï¸âƒ£ : HITUNG HPP (SAMA PERSIS DENGAN LAPORAN HPP)
   ========================================================= */

// ======================= DATA PO (MASUK) =======================
$aggPiDetail = DB::table('t_pi_bahan_d as tpid')
    ->select(
        'tpid.t_penerimaan_id',
        DB::raw('AVG(tpid.harga_nett) AS avg_harga_nett'),
        DB::raw('MAX(tpid.kadar_air)  AS max_kadar_air')
    )
    ->groupBy('tpid.t_penerimaan_id');

$dataPo = DB::table('t_penerimaan as tp')
    ->join('t_po_bahan as tpo', 'tpo.id', '=', 'tp.t_po_bahan_id')
    ->join('m_supplier as ms', 'ms.id', '=', 'tpo.m_supplier_id')
    ->leftJoinSub($aggPiDetail, 'pid', fn($j) => $j->on('pid.t_penerimaan_id', '=', 'tp.id'))
    ->select(
        'tpo.no_po as no_referensi',
        'tp.no_penerimaan',
        'tp.tgl_penerimaan as tanggal',
        'ms.nama_supplier as supplier_customer',
        DB::raw('COALESCE(MAX(pid.max_kadar_air), tp.kadar_air, 0)::numeric AS kadar_air'),
        DB::raw('COALESCE(MAX(pid.avg_harga_nett), tpo.harga_sepakat, 0)::numeric AS harga_nett'),
        DB::raw('SUM(tp.total_netto)::numeric AS berat_masuk'),
        DB::raw('NULL::numeric AS berat_keluar'),
        DB::raw('NULL::numeric AS hpp_adj'),
        DB::raw('NULL::numeric AS total_adj'),
        DB::raw('MIN(tp.created_at) AS created_src'),
        DB::raw('NULL::bigint AS sj_id')
    )
    ->where('tp.status', 'POST')
    ->when($periodeTo,   fn($q) => $q->whereDate('tp.tgl_penerimaan', '<=', $periodeTo))
    ->groupBy('tpo.no_po', 'tp.no_penerimaan', 'tp.tgl_penerimaan', 'ms.nama_supplier', 'tpo.harga_sepakat', 'tp.kadar_air');

// ======================= DATA SO / SJ (KELUAR) =======================
$dataSo = DB::table('t_surat_jalan as tsj')
    ->join('t_sales_order as tso','tso.id','=','tsj.t_sales_order_id')
    ->join('m_customer as mc','mc.id','=','tso.m_customer_id')
    ->select(
        'tso.no_so as no_referensi',
        DB::raw('NULL::text as no_penerimaan'),
        'tsj.tgl as tanggal',
        'mc.nama as supplier_customer',
        DB::raw('NULL::numeric as kadar_air'),
        DB::raw('NULL::numeric as harga_nett'),
        DB::raw('NULL::numeric as berat_masuk'),
        'tsj.berat_kirim as berat_keluar',
        DB::raw('NULL::numeric as hpp_adj'),
        DB::raw('NULL::numeric as total_adj'),
        DB::raw('tsj.created_at as created_src'),
        'tsj.id as sj_id'
    )
    // NOTE: TIDAK ADA where status POST - SAMA DENGAN LAPORAN HPP
    ->when($periodeTo,   fn($q) => $q->whereDate('tsj.tgl', '<=', $periodeTo));

// ======================= DATA ADJUSTMENT =======================
$dataAdj = DB::table('t_adjustment_stock as tas')
    ->join('t_adjustment_stock_d as tasd','tasd.t_adjustment_stock_id','=','tas.id')
    ->select(
        'tas.no_adj as no_referensi',
        DB::raw('NULL::text as no_penerimaan'),
        'tas.tgl as tanggal',
        DB::raw("'Adjustment Stock' as supplier_customer"),
        DB::raw('NULL::numeric as kadar_air'),
        DB::raw('COALESCE(tasd.harga_nett,0)::numeric as harga_nett'),
        DB::raw("CASE WHEN tasd.berat_adjustment > 0 THEN tasd.berat_adjustment ELSE NULL END::numeric as berat_masuk"),
        DB::raw("CASE WHEN tasd.berat_adjustment < 0 THEN ABS(tasd.berat_adjustment) ELSE NULL END::numeric as berat_keluar"),
        DB::raw('COALESCE(tasd.hpp,0)::numeric as hpp_adj'),
        DB::raw('COALESCE(tasd.total,0)::numeric as total_adj'),
        DB::raw('tas.created_at as created_src'),
        DB::raw('NULL::bigint AS sj_id')
    )
    ->where('tas.status','POST')
    ->when($periodeTo,   fn($q) => $q->whereDate('tas.tgl', '<=', $periodeTo));

// ======================= UNION ALL & SORT =======================
$allTransaksi = DB::query()
    ->fromSub(
        $dataPo->unionAll($dataSo)->unionAll($dataAdj),
        'history'
    )
    ->orderBy('tanggal', 'asc')
    ->orderBy('created_src', 'asc')
    ->get();

// ======================= VARIABEL AGREGAT =======================
$stok  = 0;
$nilai = 0.0;
$hpp   = 0.0;

/**
 * MAP: sj_id => hpp_keluar
 * HARUS SAMA PERSIS dengan $rowHargaHppKeluar di laporan HPP
 */
$sjHppMap = [];

foreach ($allTransaksi as $row) {
    $beratMasuk   = (float)($row->berat_masuk ?? 0);
    $beratKeluar  = (float)($row->berat_keluar ?? 0);
    $hargaNetInit = (float)($row->harga_nett ?? 0);
    $hppAdj        = (float)($row->hpp_adj ?? 0);
    $totalAdj      = (float)($row->total_adj ?? 0);

    $isAdjustment = (stripos((string)$row->supplier_customer, 'Adjustment') !== false);
    $hppBefore = $hpp;

    $rowHargaNett       = $hargaNetInit;
    $rowTotalMasuk      = 0.0;
    $rowHargaHppKeluar  = 0.0;
    $rowTotalKeluar     = 0.0;

    // =================== CALCULATE MOVING AVERAGE (SAMA PERSIS DENGAN LAPORAN HPP) ===================
    if (!$isAdjustment && $beratMasuk > 0) {
        $rowTotalMasuk = $beratMasuk * $rowHargaNett;
        $nilai += $rowTotalMasuk;
        $stok  += $beratMasuk;
        $hpp   = $stok > 0 ? ($nilai / $stok) : 0;
    }
    elseif (!$isAdjustment && $beratKeluar > 0) {
        // ðŸ”´ INI PERSIS SAMA DENGAN LAPORAN HPP (line 207 web_report_hpp.blade.php)
        $rowHargaHppKeluar = $hppBefore;
        $rowTotalKeluar    = $beratKeluar * $rowHargaHppKeluar;
        
        // Simpan ke map berdasarkan sj_id
        if ($row->sj_id) {
            $sjHppMap[$row->sj_id] = $rowHargaHppKeluar;
        }
        
        $nilai -= $rowTotalKeluar;
        $stok  -= $beratKeluar;
        $hpp   = $stok > 0 ? ($nilai / $stok) : 0;
    }
    elseif ($isAdjustment) {
        if ($beratMasuk > 0) {
            // Koreksi Nilai Adjustment Plus (SAMA PERSIS DENGAN LAPORAN HPP)
            if ($totalAdj > 0) $rowTotalMasuk = $totalAdj;
            elseif ($rowHargaNett > 0) $rowTotalMasuk = $beratMasuk * $rowHargaNett;
            else $rowTotalMasuk = 0; // Stok only adjustment

            $nilai += $rowTotalMasuk;
            $stok  += $beratMasuk;
            $hpp   = $stok > 0 ? ($nilai / $stok) : 0;
        } elseif ($beratKeluar > 0) {
            // Koreksi Nilai Adjustment Minus (SAMA PERSIS DENGAN LAPORAN HPP)
            if ($totalAdj > 0) $rowTotalKeluar = $totalAdj;
            elseif ($hppAdj > 0) $rowTotalKeluar = $beratKeluar * $hppAdj;
            else $rowTotalKeluar = 0; // Stok only adjustment

            $nilai -= $rowTotalKeluar;
            $stok  -= $beratKeluar;
            $hpp   = $stok > 0 ? ($nilai / $stok) : 0;
            $rowHargaHppKeluar = $beratKeluar > 0 ? ($rowTotalKeluar / $beratKeluar) : 0;
        }
    }
}

/* =========================================================
   STEP 2ï¸âƒ£ : DATA PENJUALAN
   ========================================================= */

$rows = DB::table('t_sales_invoice as si')
    ->join('t_sales_invoice_d as sid','sid.t_sales_invoice_id','=','si.id')
    ->leftJoin('t_surat_jalan as sj','sj.id','=','sid.t_surat_jalan_id')
    ->leftJoin('t_sales_order as so','so.id','=','si.t_sales_order_id')
    ->leftJoin('m_customer as mc','mc.id','=','so.m_customer_id')
    ->leftJoin('t_po_bahan as po','po.id','=','si.t_po_bahan_id')
    ->leftJoin('m_supplier as ms','ms.id','=','po.m_supplier_id')
    ->select(
        'si.id',
        'si.is_trading',
        'so.no_po_customer',
        'so.no_so',
        'mc.nama as nama_customer',
        'so.penerima',
        'so.harga as harga_so',
        'sid.tgl_sj',
        'sid.no_polisi',
        'sid.berat_sj',
        'sid.berat_si',
        'sid.berat_net',
        'sid.harga_net',
        'sid.total as total_si',
        'sid.t_surat_jalan_id as sj_id',
        'po.harga_sepakat',
        'ms.nama_supplier'
    )
    ->where('si.status','POST')
    ->when($periodeFrom, fn($q)=>$q->whereDate('sid.tgl_sj','>=',$periodeFrom))
    ->when($periodeTo,   fn($q)=>$q->whereDate('sid.tgl_sj','<=',$periodeTo))
    ->orderBy('sid.tgl_sj')
    ->orderBy('si.id')
    ->get();
@endphp

<div>
  <h1 style="font-weight:bold;text-align:center;">Laporan Penjualan Gudang</h1>
  <p style="text-align:center;">
    Periode :
    {{ $periodeFrom ? $helper->formatDateId($periodeFrom) : 'Awal' }}
    {{ $periodeTo ? '- '.$helper->formatDateId($periodeTo) : '' }}
  </p><br>

  <table style="border:1px solid black;border-collapse:collapse;width:100%;font-size:8px;">
    <thead>
      <tr style="background:#f2f2f2;">
        @foreach(['No','No PO','Supplier','Harga PO / HPP','No SO','Customer','Penerima','Harga SO','Tanggal','No Pol','Berat SJ','Berat SI','Berat Net','Harga Net','Total SI','Total HPP'] as $h)
          <th style="border:1px solid #000;padding:4px;text-align:center;">{{ $h }}</th>
        @endforeach
      </tr>
    </thead>
    <tbody>
    @foreach($rows as $i=>$r)
      @php
        if ($r->is_trading) {
            $hppSatuan = (float)$r->harga_sepakat;
            $totalHpp  = $hppSatuan * (float)$r->berat_sj;
            $supplier  = $r->nama_supplier;
        } else {
            // ðŸ”´ PASTI SAMA DENGAN LAPORAN HPP
            $hppSatuan = $sjHppMap[$r->sj_id] ?? 0;
            $totalHpp  = $hppSatuan * (float)$r->berat_sj;
            $supplier  = 'CV TOFAN';
        }
      @endphp
      <tr>
        <td style="border:1px solid #000;text-align:center;">{{ $i+1 }}</td>
        <td style="border:1px solid #000;text-align:center;">{{ $r->no_po_customer ?? '-' }}</td>
        <td style="border:1px solid #000;">{{ $supplier }}</td>
        <td style="border:1px solid #000;text-align:right;{{ $isExcelExport ? $cellNumberStyle : '' }}">
          {{ $isExcelExport ? $fmtExportPlain($hppSatuan) : $fmtBrowser($hppSatuan) }}
        </td>
        <td style="border:1px solid #000;text-align:center;">{{ $r->no_so }}</td>
        <td style="border:1px solid #000;">{{ $r->nama_customer }}</td>
        <td style="border:1px solid #000;text-align:center;">{{ $r->penerima }}</td>
        <td style="border:1px solid #000;text-align:right;{{ $isExcelExport ? $cellNumberStyle : '' }}">
          {{ $isExcelExport ? $fmtExportPlain($r->harga_so) : $fmtBrowser($r->harga_so) }}
        </td>
        <td style="border:1px solid #000;text-align:center;">{{ date('d/m/Y', strtotime($r->tgl_sj)) }}</td>
        <td style="border:1px solid #000;text-align:center;">{{ $r->no_polisi }}</td>
        <td style="border:1px solid #000;text-align:right;{{ $isExcelExport ? $cellNumberStyle : '' }}">
          {{ $isExcelExport ? $fmtExportPlain($r->berat_sj) : number_format($r->berat_sj,0,',','.') }}
        </td>
        <td style="border:1px solid #000;text-align:right;{{ $isExcelExport ? $cellNumberStyle : '' }}">
          {{ $isExcelExport ? $fmtExportPlain($r->berat_si) : number_format($r->berat_si,0,',','.') }}
        </td>
        <td style="border:1px solid #000;text-align:right;{{ $isExcelExport ? $cellNumberStyle : '' }}">
          {{ $isExcelExport ? $fmtExportPlain($r->berat_net) : number_format($r->berat_net,0,',','.') }}
        </td>
        <td style="border:1px solid #000;text-align:right;{{ $isExcelExport ? $cellNumberStyle : '' }}">
          {{ $isExcelExport ? $fmtExportPlain($r->harga_net) : $fmtBrowser($r->harga_net) }}
        </td>
        <td style="border:1px solid #000;text-align:right;{{ $isExcelExport ? $cellNumberStyle : '' }}">
          {{ $isExcelExport ? $fmtExportPlain($r->total_si) : $fmtBrowser($r->total_si) }}
        </td>
        <td style="border:1px solid #000;text-align:right;{{ $isExcelExport ? $cellNumberStyle : '' }}">
          {{ $isExcelExport ? $fmtExportPlain($totalHpp) : $fmtBrowser($totalHpp) }}
        </td>
      </tr>
    @endforeach
    </tbody>
  </table>
</div>
