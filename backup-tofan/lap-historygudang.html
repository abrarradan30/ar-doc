@php
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;

$req     = app()->request;
$helper  = getCore('Helper');

// =================== EXPORT HANDLING ===================
$exportParam   = strtolower((string)($req->get('export') ?? ''));
$isExcelExport = in_array($exportParam, ['xls','xlsx','excel','csv'], true);

$fmtExportPlain = fn($v) => (int)round((float)($v ?? 0));
$cellNumberStyle = "mso-number-format:'\\0022Rp\\0022 #,##0';";

// =================== PARAMETER ===================
$gudangId   = $req->get('gudang_id');
$kavlingId  = $req->get('kavling_id');
$periodeFrom = $req->get('periode_from') ? date('Y-m-d', strtotime($req->get('periode_from'))) : null;
$periodeTo   = $req->get('periode_to') ? date('Y-m-d', strtotime($req->get('periode_to'))) : null;

// =================== QUERY SEMUA DATA (TANPA FILTER GUDANG/KAVLING) ===================
// Balance dihitung secara GLOBAL, filter hanya untuk tampilan

// --- 1) PO MASUK ---
$po = DB::table('t_penerimaan as tp')
    ->join('t_po_bahan as tpo','tpo.id','=','tp.t_po_bahan_id')
    ->leftJoin('m_supplier as ms','ms.id','=','tpo.m_supplier_id')
    ->leftJoin('m_gudang as mg','mg.id','=','tp.m_gudang_id')
    ->leftJoin('m_gudang_d as mgd','mgd.id','=','tp.kavling_id')
    ->where('tp.status','POST')
    ->selectRaw("
        tp.tgl_penerimaan as tanggal,
        tpo.no_po::text as no_referensi,
        ms.nama_supplier::text as nama_supplier_customer,
        tp.kadar_air::numeric as kadar_air,
        mg.nama::text as nama_gudang,
        mgd.nama::text as nama_kavling,
        tp.m_gudang_id as gudang_id,
        tp.kavling_id as kavling_id,
        tp.total_netto::numeric as berat_masuk,
        NULL::numeric as berat_keluar,
        tp.created_at
    ");

// --- 2) SJ KELUAR (samakan dengan stock overview - pakai berat_kirim dari header) ---
$so = DB::table('t_surat_jalan as tsj')
    ->join('t_sales_order as tso','tso.id','=','tsj.t_sales_order_id')
    ->leftJoin('m_customer as mc','mc.id','=','tso.m_customer_id')
    ->leftJoin('t_surat_jalan_d as tsjd','tsjd.t_surat_jalan_id','=','tsj.id')
    ->leftJoin('m_gudang as mg','mg.id','=','tsjd.m_gudang_id')
    ->leftJoin('m_gudang_d as mgd','mgd.id','=','tsjd.m_gudang_d_id')
    ->selectRaw("
        tsj.tgl as tanggal,
        tso.no_so::text as no_referensi,
        mc.nama::text as nama_supplier_customer,
        NULL::numeric as kadar_air,
        mg.nama::text as nama_gudang,
        mgd.nama::text as nama_kavling,
        tsjd.m_gudang_id as gudang_id,
        tsjd.m_gudang_d_id as kavling_id,
        NULL::numeric as berat_masuk,
        COALESCE(tsjd.berat_sj,0)::numeric as berat_keluar,
        tsj.created_at
    ");

// --- 2B) SJ KELUAR GLOBAL (untuk balance global - samakan dengan stock overview) ---
$soGlobal = DB::table('t_surat_jalan as tsj')
    ->join('t_sales_order as tso','tso.id','=','tsj.t_sales_order_id')
    ->leftJoin('m_customer as mc','mc.id','=','tso.m_customer_id')
    ->selectRaw("
        tsj.tgl as tanggal,
        tso.no_so::text as no_referensi,
        mc.nama::text as nama_supplier_customer,
        NULL::numeric as kadar_air,
        NULL::text as nama_gudang,
        NULL::text as nama_kavling,
        NULL::integer as gudang_id,
        NULL::integer as kavling_id,
        NULL::numeric as berat_masuk,
        COALESCE(tsj.berat_kirim,0)::numeric as berat_keluar,
        tsj.created_at
    ");

// --- 3) ADJUSTMENT ---
$adjustment = DB::table('t_adjustment_stock_d as tasd')
    ->join('t_adjustment_stock as tas','tas.id','=','tasd.t_adjustment_stock_id')
    ->leftJoin('m_gudang as mg','mg.id','=','tas.m_gudang_id')
    ->leftJoin('m_gudang_d as mgd','mgd.id','=','tas.m_gudang_d_id')
    ->where('tas.status','POST')
    ->selectRaw("
        tas.tgl as tanggal,
        tas.no_adj::text as no_referensi,
        'Adjustment Stock'::text as nama_supplier_customer,
        NULL::numeric as kadar_air,
        mg.nama::text as nama_gudang,
        mgd.nama::text as nama_kavling,
        tas.m_gudang_id as gudang_id,
        tas.m_gudang_d_id as kavling_id,
        CASE WHEN tasd.berat_adjustment > 0 THEN tasd.berat_adjustment ELSE NULL END::numeric as berat_masuk,
        CASE WHEN tasd.berat_adjustment < 0 THEN ABS(tasd.berat_adjustment) ELSE NULL END::numeric as berat_keluar,
        tas.created_at
    ");

// --- 4) TRANSFER GUDANG ---
$transferAsal = DB::table('t_transfer_gudang as ttg')
    ->leftJoin('m_gudang as mg','mg.id','=','ttg.m_gudang_a_id')
    ->leftJoin('m_gudang_d as mgd','mgd.id','=','ttg.m_gudang_d_a_id')
    ->where('ttg.status','POST')
    ->selectRaw("
        ttg.tgl as tanggal,
        ttg.no_tg::text as no_referensi,
        'Transfer Gudang'::text as nama_supplier_customer,
        NULL::numeric as kadar_air,
        mg.nama::text as nama_gudang,
        mgd.nama::text as nama_kavling,
        ttg.m_gudang_a_id as gudang_id,
        ttg.m_gudang_d_a_id as kavling_id,
        NULL::numeric as berat_masuk,
        COALESCE(ttg.berat,0)::numeric as berat_keluar,
        ttg.created_at
    ");

$transferTujuan = DB::table('t_transfer_gudang as ttg')
    ->leftJoin('m_gudang as mg','mg.id','=','ttg.m_gudang_t_id')
    ->leftJoin('m_gudang_d as mgd','mgd.id','=','ttg.m_gudang_d_t_id')
    ->where('ttg.status','POST')
    ->selectRaw("
        ttg.tgl as tanggal,
        ttg.no_tg::text as no_referensi,
        'Transfer Gudang'::text as nama_supplier_customer,
        NULL::numeric as kadar_air,
        mg.nama::text as nama_gudang,
        mgd.nama::text as nama_kavling,
        ttg.m_gudang_t_id as gudang_id,
        ttg.m_gudang_d_t_id as kavling_id,
        COALESCE(ttg.berat,0)::numeric as berat_masuk,
        NULL::numeric as berat_keluar,
        ttg.created_at
    ");

$transfer = $transferAsal->unionAll($transferTujuan);

// --- 5) TRANSFORM ITEM ---
$transformAsal = DB::table('t_transform_item as tti')
    ->leftJoin('m_gudang as mg','mg.id','=','tti.m_gudang_a_id')
    ->leftJoin('m_gudang_d as mgd','mgd.id','=','tti.m_gudang_d_a_id')
    ->where('tti.status','POST')
    ->selectRaw("
        tti.tgl as tanggal,
        tti.no_ti::text as no_referensi,
        'Transform Item'::text as nama_supplier_customer,
        NULL::numeric as kadar_air,
        mg.nama::text as nama_gudang,
        mgd.nama::text as nama_kavling,
        tti.m_gudang_a_id as gudang_id,
        tti.m_gudang_d_a_id as kavling_id,
        NULL::numeric as berat_masuk,
        COALESCE(tti.berat,0)::numeric as berat_keluar,
        tti.created_at
    ");

$transformTujuan = DB::table('t_transform_item as tti')
    ->leftJoin('m_gudang as mg','mg.id','=','tti.m_gudang_t_id')
    ->leftJoin('m_gudang_d as mgd','mgd.id','=','tti.m_gudang_d_t_id')
    ->where('tti.status','POST')
    ->selectRaw("
        tti.tgl as tanggal,
        tti.no_ti::text as no_referensi,
        'Transform Item'::text as nama_supplier_customer,
        NULL::numeric as kadar_air,
        mg.nama::text as nama_gudang,
        mgd.nama::text as nama_kavling,
        tti.m_gudang_t_id as gudang_id,
        tti.m_gudang_d_t_id as kavling_id,
        COALESCE(tti.berat,0)::numeric as berat_masuk,
        NULL::numeric as berat_keluar,
        tti.created_at
    ");

$transform = $transformAsal->unionAll($transformTujuan);

// --- GABUNG SEMUA DATA UNTUK TAMPILAN (dengan detail gudang/kavling) ---
$allData = DB::query()
    ->fromSub($po
        ->unionAll($so)
        ->unionAll($adjustment)
        ->unionAll($transfer)
        ->unionAll($transform), 'history')
    ->orderBy('tanggal','asc')
    ->orderBy('created_at','asc')
    ->get();

// =================== HITUNG BALANCE GLOBAL (SAMAKAN DENGAN STOCK OVERVIEW) ===================
// Menggunakan metode yang sama persis dengan web_report_laporan_stock.blade.php

// --- DATA GLOBAL MASUK (PO/PENERIMAAN) ---
$dataPoGlobal = DB::table('t_penerimaan as tp')
    ->join('t_po_bahan as tpo','tpo.id','=','tp.t_po_bahan_id')
    ->where('tp.status','POST')
    ->when($periodeTo, fn($q)=>$q->whereDate('tp.tgl_penerimaan','<=',$periodeTo))
    ->selectRaw("
        tp.tgl_penerimaan as tanggal,
        SUM(tp.total_netto)::numeric as berat_masuk,
        NULL::numeric as berat_keluar,
        NULL::numeric as total_adj,
        'PO'::text as tipe,
        MIN(tp.created_at) as created_src
    ")
    ->groupBy('tp.tgl_penerimaan');

// --- DATA GLOBAL KELUAR (SO/SJ) - pakai berat_kirim dari header ---
$dataSoGlobal = DB::table('t_surat_jalan as tsj')
    ->when($periodeTo, fn($q)=>$q->whereDate('tsj.tgl','<=',$periodeTo))
    ->selectRaw("
        tsj.tgl as tanggal,
        NULL::numeric as berat_masuk,
        COALESCE(tsj.berat_kirim,0)::numeric as berat_keluar,
        NULL::numeric as total_adj,
        'SJ'::text as tipe,
        tsj.created_at as created_src
    ");

// --- DATA GLOBAL ADJUSTMENT ---
$dataAdjGlobal = DB::table('t_adjustment_stock as tas')
    ->join('t_adjustment_stock_d as tasd','tasd.t_adjustment_stock_id','=','tas.id')
    ->where('tas.status','POST')
    ->when($periodeTo, fn($q)=>$q->whereDate('tas.tgl','<=',$periodeTo))
    ->selectRaw("
        tas.tgl as tanggal,
        CASE WHEN tasd.berat_adjustment > 0 THEN tasd.berat_adjustment ELSE NULL END::numeric as berat_masuk,
        CASE WHEN tasd.berat_adjustment < 0 THEN ABS(tasd.berat_adjustment) ELSE NULL END::numeric as berat_keluar,
        COALESCE(tasd.total,0)::numeric as total_adj,
        'ADJ'::text as tipe,
        tas.created_at as created_src
    ");

// --- UNION DATA GLOBAL (TANPA Transfer & Transform karena net = 0) ---
$allGlobalData = DB::query()
    ->fromSub($dataPoGlobal->unionAll($dataSoGlobal)->unionAll($dataAdjGlobal), 'global_history')
    ->orderBy('tanggal','asc')
    ->orderBy('created_src','asc')
    ->get();

// --- HITUNG BALANCE GLOBAL ---
$globalBalance = 0;
foreach ($allGlobalData as $row) {
    $beratMasuk  = (float)($row->berat_masuk ?? 0);
    $beratKeluar = (float)($row->berat_keluar ?? 0);
    $globalBalance += $beratMasuk - $beratKeluar;
}

// =================== FILTER TAMPILAN & HITUNG RUNNING BALANCE ===================
// Jika ada filter gudang/kavling, hitung balance khusus untuk filter tersebut
// Jika tidak ada filter, gunakan balance global

$filteredBalance = 0;  // Balance untuk data yang difilter (gudang/kavling tertentu)
$displayData = [];
$rowNumber = 0;

foreach ($allData as $row) {
    $beratMasuk  = (float)($row->berat_masuk ?? 0);
    $beratKeluar = (float)($row->berat_keluar ?? 0);
    
    // Cek apakah row ini masuk filter gudang/kavling
    $matchGudang = true;
    $matchKavling = true;
    $matchPeriode = true;
    
    if ($gudangId && $row->gudang_id != $gudangId) {
        $matchGudang = false;
    }
    if ($kavlingId && $row->kavling_id != $kavlingId) {
        $matchKavling = false;
    }
    // Filter periode untuk balance (hanya sampai periodeTo)
    if ($periodeTo && $row->tanggal > $periodeTo) {
        $matchPeriode = false;
    }
    
    // Jika ada filter gudang/kavling, hanya hitung balance untuk transaksi yang match
    // Dan pastikan dalam periode yang dipilih
    if ($matchGudang && $matchKavling && $matchPeriode) {
        $filteredBalance += $beratMasuk - $beratKeluar;
    }
    
    // Simpan running balance ke row (hanya jika dalam filter)
    if ($matchGudang && $matchKavling && $matchPeriode) {
        $row->calculated_balance = $filteredBalance;
    }
    
    // Cek apakah row ini masuk filter tampilan (termasuk periode)
    $showRow = true;
    
    // Filter periode (untuk tampilan, termasuk periodeFrom)
    if ($periodeFrom && $row->tanggal < $periodeFrom) {
        $showRow = false;
    }
    if (!$matchPeriode) {
        $showRow = false;
    }
    
    // Filter gudang
    if (!$matchGudang) {
        $showRow = false;
    }
    
    // Filter kavling
    if (!$matchKavling) {
        $showRow = false;
    }
    
    if ($showRow) {
        $rowNumber++;
        $row->row_number = $rowNumber;
        $displayData[] = $row;
    }
}

$data = collect($displayData);

// =================== BALANCE AKHIR ===================
// Jika ada filter gudang/kavling → gunakan balance yang sudah difilter
// Jika tidak ada filter → gunakan balance global (sama dengan stock overview)
$balanceGlobal = ($gudangId || $kavlingId) ? $filteredBalance : $globalBalance;
@endphp

{{-- =================== VIEW =================== --}}
<div>
  <div style="text-align:center; margin-bottom:10px;">
    <h1 style="font-weight:bold; margin:0;">LAPORAN HISTORY GUDANG</h1>
    <p style="margin:4px 0 0 0;">
      PERIODE 
      {{ $req->periode_from ? $helper->formatDateId($req->periode_from) : '-' }}
      {{ $req->periode_to ? '- '.$helper->formatDateId($req->periode_to) : '' }}
    </p>
  </div>

  <table style="border-collapse: collapse; width: 100%; font-size: 13px;">
    <thead>
      <tr>
        <th style="border:1px solid #000;padding:6px;text-align:center;font-size:10px;">No.</th>
        <th style="border:1px solid #000;padding:6px;text-align:center;font-size:10px;">Tanggal</th>
        <th style="border:1px solid #000;padding:6px;text-align:center;font-size:10px;">No Referensi</th>
        <th style="border:1px solid #000;padding:6px;text-align:center;font-size:10px;">Gudang</th>
        <th style="border:1px solid #000;padding:6px;text-align:center;font-size:10px;">Kavling</th>
        <th style="border:1px solid #000;padding:6px;text-align:center;font-size:10px;">Supplier / Customer</th>
        <th style="border:1px solid #000;padding:6px;text-align:center;font-size:10px;">KA (%)</th>
        <th style="border:1px solid #000;padding:6px;text-align:center;font-size:10px;">Berat Masuk</th>
        <th style="border:1px solid #000;padding:6px;text-align:center;font-size:10px;">Berat Keluar</th>
        <th style="border:1px solid #000;padding:6px;text-align:center;font-size:10px;">Balance</th>
      </tr>
    </thead>
    <tbody>
      @foreach($data as $row)
        @php
          $beratMasuk  = (float)($row->berat_masuk ?? 0);
          $beratKeluar = (float)($row->berat_keluar ?? 0);
        @endphp
        <tr>
          <td style="border:1px solid #000;padding:4px;text-align:center;font-size:10px;">{{ $row->row_number }}</td>
          <td style="border:1px solid #000;padding:4px;text-align:center;font-size:10px;">{{ \Carbon\Carbon::parse($row->tanggal)->format('d/m/Y') }}</td>
          <td style="border:1px solid #000;padding:4px;font-size:10px;">{{ $row->no_referensi ?? '-' }}</td>
          <td style="border:1px solid #000;padding:4px;font-size:10px;">{{ $row->nama_gudang ?? '-' }}</td>
          <td style="border:1px solid #000;padding:4px;font-size:10px;">{{ $row->nama_kavling ?? '-' }}</td>
          <td style="border:1px solid #000;padding:4px;font-size:10px;">{{ $row->nama_supplier_customer ?? '-' }}</td>
          <td style="border:1px solid #000;padding:4px;text-align:center;font-size:10px;">
            {{ isset($row->kadar_air) ? rtrim(rtrim(number_format((float)$row->kadar_air, 1, ',', ''), '0'), ',') : '' }}
          </td>
          <td style="border:1px solid #000;text-align:right;padding:4px;font-size:10px;{{ $isExcelExport ? $cellNumberStyle : '' }}">
            {{ $isExcelExport ? $fmtExportPlain($beratMasuk) : number_format($beratMasuk, 0, ',', '.') }}
          </td>
          <td style="border:1px solid #000;text-align:right;padding:4px;font-size:10px;{{ $isExcelExport ? $cellNumberStyle : '' }}">
            {{ $isExcelExport ? $fmtExportPlain($beratKeluar) : number_format($beratKeluar, 0, ',', '.') }}
          </td>
          <td style="border:1px solid #000;text-align:right;padding:4px;font-size:10px;{{ $isExcelExport ? $cellNumberStyle : '' }}">
            {{ $isExcelExport ? $fmtExportPlain($row->calculated_balance) : number_format($row->calculated_balance, 0, ',', '.') }}
          </td>
        </tr>
      @endforeach
      
      {{-- TOTAL ROW - Balance Global (samakan dengan Stock Overview) --}}
      @php
        $totalMasuk = $data->sum(fn($r) => (float)($r->berat_masuk ?? 0));
        $totalKeluar = $data->sum(fn($r) => (float)($r->berat_keluar ?? 0));
      @endphp
      <tr style="font-weight:bold;background:#f2f2f2;">
        <td colspan="7" style="border:1px solid #000;padding:6px;text-align:center;font-size:10px;">TOTAL</td>
        <td style="border:1px solid #000;text-align:right;padding:6px;font-size:10px;{{ $isExcelExport ? $cellNumberStyle : '' }}">
          {{ $isExcelExport ? $fmtExportPlain($totalMasuk) : number_format($totalMasuk, 0, ',', '.') }}
        </td>
        <td style="border:1px solid #000;text-align:right;padding:6px;font-size:10px;{{ $isExcelExport ? $cellNumberStyle : '' }}">
          {{ $isExcelExport ? $fmtExportPlain($totalKeluar) : number_format($totalKeluar, 0, ',', '.') }}
        </td>
        <td style="border:1px solid #000;text-align:right;padding:6px;font-size:10px;font-weight:bold;background:#e6ffe6;{{ $isExcelExport ? $cellNumberStyle : '' }}">
          {{ $isExcelExport ? $fmtExportPlain($balanceGlobal) : number_format($balanceGlobal, 0, ',', '.') }}
        </td>
      </tr>
    </tbody>
  </table>
</div>
