@php
use Illuminate\Support\Facades\DB;
use Carbon\Carbon;

$req    = app()->request;
$helper = getCore('Helper');

// --------------------------------------------------------
// Export & Formatter
// --------------------------------------------------------
$exportParam   = strtolower((string)($req->get('export') ?? ''));
$isExcelExport = in_array($exportParam, ['xls','xlsx','excel','csv'], true);

$fmtBrowser      = fn($v) => 'Rp ' . number_format(abs((float)($v ?? 0)), 0, ',', '.');
$fmtExportPlain  = fn($v) => (int)round((float)($v ?? 0));
$cellNumberStyle = "mso-number-format:'\\0022Rp\\0022 #,##0';";

// --------------------------------------------------------
// Parameter
// --------------------------------------------------------
$periodeFrom = $req->get('periode_from') ? date('Y-m-d', strtotime($req->get('periode_from'))) : null;
$periodeTo   = $req->get('periode_to')   ? date('Y-m-d', strtotime($req->get('periode_to')))   : null;

// =========================================================
// 1️⃣ DATA MASUK (PO/PENERIMAAN)
// =========================================================
$aggPiDetail = DB::table('t_pi_bahan_d as tpid')
  ->select(
    'tpid.t_penerimaan_id',
    DB::raw('AVG(tpid.harga_nett) AS avg_harga_nett'),
    DB::raw('MAX(tpid.kadar_air) AS max_kadar_air')
  )
  ->groupBy('tpid.t_penerimaan_id');

$dataPo = DB::table('t_penerimaan as tp')
  ->join('t_po_bahan as tpo','tpo.id','=','tp.t_po_bahan_id')
  ->join('m_supplier as ms','ms.id','=','tpo.m_supplier_id')
  ->leftJoinSub($aggPiDetail,'pid',fn($j)=>$j->on('pid.t_penerimaan_id','=','tp.id'))
  ->select(
    'tpo.no_po as no_referensi',
    'tp.no_penerimaan',
    'tp.tgl_penerimaan as tanggal',
    'ms.nama_supplier as supplier_customer',
    DB::raw('COALESCE(MAX(pid.max_kadar_air), tp.kadar_air, 0)::numeric as kadar_air'),
    DB::raw('COALESCE(MAX(pid.avg_harga_nett), tpo.harga_sepakat, 0)::numeric as harga_nett'),
    DB::raw('SUM(tp.total_netto)::numeric as berat_masuk'),
    DB::raw('NULL::numeric as berat_keluar'),
    DB::raw('NULL::numeric as hpp_adj'),
    DB::raw('NULL::numeric as total_adj'),
    DB::raw('MIN(tp.created_at) as created_src')
  )
  ->where('tp.status','POST')
  // NOTE: periodeFrom dihilangkan agar saldo awal ikut terhitung (samakan dengan laporan HPP)
  ->when($periodeTo,   fn($q)=>$q->whereDate('tp.tgl_penerimaan','<=',$periodeTo))
  ->groupBy('tpo.no_po','tp.no_penerimaan','tp.tgl_penerimaan','ms.nama_supplier','tpo.harga_sepakat','tp.kadar_air');

// =========================================================
// 2️⃣ DATA KELUAR (SO/SJ)
// =========================================================
$dataSo = DB::table('t_surat_jalan as tsj')
  ->join('t_sales_order as tso','tso.id','=','tsj.t_sales_order_id')
  ->join('m_customer as mc','mc.id','=','tso.m_customer_id')
  ->select(
    'tso.no_so as no_referensi',
    DB::raw('NULL::text as no_penerimaan'),
    'tsj.tgl as tanggal',
    'mc.nama as supplier_customer',
    DB::raw('NULL::numeric as kadar_air'),
    DB::raw('NULL::numeric as harga_nett'),
    DB::raw('NULL::numeric as berat_masuk'),
    'tsj.berat_kirim as berat_keluar',
    DB::raw('NULL::numeric as hpp_adj'),
    DB::raw('NULL::numeric as total_adj'),
    DB::raw('tsj.created_at as created_src')
  )
  // NOTE: periodeFrom dihilangkan agar saldo awal ikut terhitung (samakan dengan laporan HPP)
  ->when($periodeTo,   fn($q)=>$q->whereDate('tsj.tgl','<=',$periodeTo));

// =========================================================
// 3️⃣ DATA ADJUSTMENT
// =========================================================
$dataAdj = DB::table('t_adjustment_stock as tas')
  ->join('t_adjustment_stock_d as tasd','tasd.t_adjustment_stock_id','=','tas.id')
  ->select(
    'tas.no_adj as no_referensi',
    DB::raw('NULL::text as no_penerimaan'),
    'tas.tgl as tanggal',
    DB::raw("'Adjustment Stock' as supplier_customer"),
    DB::raw('NULL::numeric as kadar_air'),
    DB::raw('COALESCE(tasd.harga_nett,0)::numeric as harga_nett'),
    DB::raw("CASE WHEN tasd.berat_adjustment > 0 THEN tasd.berat_adjustment ELSE NULL END::numeric as berat_masuk"),
    DB::raw("CASE WHEN tasd.berat_adjustment < 0 THEN ABS(tasd.berat_adjustment) ELSE NULL END::numeric as berat_keluar"),
    DB::raw('COALESCE(tasd.hpp,0)::numeric as hpp_adj'),
    DB::raw('COALESCE(tasd.total,0)::numeric as total_adj'),
    DB::raw('tas.created_at as created_src')
  )
  ->where('tas.status','POST')
  // NOTE: periodeFrom dihilangkan agar saldo awal ikut terhitung (samakan dengan laporan HPP)
  ->when($periodeTo,   fn($q)=>$q->whereDate('tas.tgl','<=',$periodeTo));

// =========================================================
// 4️⃣ UNION SEMUA TRANSAKSI
// =========================================================
$allTransaksi = DB::query()
  ->fromSub($dataPo->unionAll($dataSo)->unionAll($dataAdj), 'history')
  ->orderBy('tanggal','asc')
  ->orderBy('created_src','asc')
  ->get();

// =========================================================
// 5️⃣ PERHITUNGAN HPP — SAMAKAN DENGAN LAPORAN HPP
// =========================================================
$stok  = 0.0;
$nilai = 0.0;
$hpp   = 0.0;

foreach ($allTransaksi as $row) {

  $beratMasuk   = (float)($row->berat_masuk ?? 0);
  $beratKeluar  = (float)($row->berat_keluar ?? 0);
  $hargaNetInit = (float)($row->harga_nett ?? 0);
  $hppAdj       = (float)($row->hpp_adj ?? 0);
  $totalAdj     = (float)($row->total_adj ?? 0);

  $isAdjustment = (stripos((string)$row->supplier_customer, 'Adjustment') !== false);
  $hppBefore    = $hpp;

  // =================== MASUK NORMAL ===================
  if (!$isAdjustment && $beratMasuk > 0 && $hargaNetInit > 0) {
    $nilai += $beratMasuk * $hargaNetInit;
    $stok  += $beratMasuk;
    $hpp    = $stok > 0 ? ($nilai / $stok) : 0;
  }

  // =================== KELUAR NORMAL ===================
  if (!$isAdjustment && $beratKeluar > 0) {
    $hargaKeluar = $hppBefore > 0 ? $hppBefore : $hpp;
    $totalKeluar = $beratKeluar * $hargaKeluar;

    $nilai -= $totalKeluar;
    $stok  -= $beratKeluar;
    $hpp    = $stok > 0 ? ($nilai / $stok) : 0;
  }

  // =================== ADJUSTMENT ===================
  if ($isAdjustment) {

    $plus  = $beratMasuk;
    $minus = $beratKeluar;

    $isStockOnlyAdjPlus = (
      $plus > 0 &&
      (float)$totalAdj == 0.0 &&
      (float)$hppAdj == 0.0 &&
      (float)$hargaNetInit == 0.0
    );

    $isStockOnlyAdjMinus = (
      $minus > 0 &&
      (float)$totalAdj == 0.0 &&
      (float)$hppAdj == 0.0 &&
      (float)$hargaNetInit == 0.0
    );

    // ========== ADJ PLUS ==========
    if ($plus > 0) {

      if ($isStockOnlyAdjPlus) {
        // ✅ hanya koreksi stok, nilai tidak berubah
        $stok += $plus;
      } else {
        if ($totalAdj > 0) {
          $nilai += $totalAdj;
        } elseif ($hargaNetInit > 0) {
          $nilai += $plus * $hargaNetInit;
        } else {
          $nilai += $plus * $hppBefore;
        }
        $stok += $plus;
      }

      $hpp = $stok > 0 ? ($nilai / $stok) : 0;
    }

    // ========== ADJ MINUS ==========
    elseif ($minus > 0) {

      if ($isStockOnlyAdjMinus) {
        // ✅ hanya koreksi stok, nilai tidak berubah
        $stok -= $minus;
      } else {
        if ($totalAdj > 0) {
          $nilai -= $totalAdj;
        } elseif ($hppAdj > 0) {
          $nilai -= $minus * $hppAdj;
        } else {
          $nilai -= $minus * $hppBefore;
        }
        $stok -= $minus;
      }

      $hpp = $stok > 0 ? ($nilai / $stok) : 0;
    }
  }
}

// ✅ Samakan dengan laporan HPP (TOTAL row)
$totalBalance   = (float)$stok;        // jangan dibulatkan dulu, biar sama persis
$totalBalanceRp = (int)round($nilai);  // laporan HPP pakai round($nilai)
$hppAkhir       = $totalBalance > 0 ? (int)round($totalBalanceRp / $totalBalance) : 0;

// =========================================================
// 6️⃣ DATA STOK GUDANG (REAL)
// =========================================================
$rawData = DB::table('m_range as mr')
  ->leftJoin('m_gudang_d_range as mgdr','mgdr.m_range_id','=','mr.id')
  ->leftJoin('m_gudang_d as mgd','mgd.id','=','mgdr.m_gudang_d_id')
  ->leftJoin('m_gudang as mg','mg.id','=','mgd.m_gudang_id')
  ->select(
    'mr.nama as nama_range',
    'mg.nama as nama_gudang',
    'mgd.nama as nama_kavling',
    DB::raw('GREATEST(mgdr.stok,0) as stok')
  )
  ->orderBy('mr.nama')
  ->orderBy('mg.nama')
  ->orderBy('mgd.nama')
  ->get();

// =========================================================
// 7️⃣ SINKRONISASI STOK REAL → TOTAL BALANCE (BIAR TOTAL ROW NYAMBUNG)
// =========================================================
$sumCurrent = (float)$rawData->sum('stok');
/*
if ($sumCurrent > 0 && abs($sumCurrent - $totalBalance) > 0.001) {
  $ratio = $totalBalance / $sumCurrent;
  $rawData = $rawData->map(function($r) use ($ratio){
    $r->stok = round(((float)$r->stok) * $ratio, 3);
    return $r;
  });
}
*/
// =========================================================
// 8️⃣ HITUNG TOTAL RP PER KAVLING (PAKAI HPP AKHIR)
// =========================================================
$rawData = $rawData->map(function($r) use ($hppAkhir){
  $r->hpp = $hppAkhir;
  $r->total_rp = (int)round(((float)$r->stok) * $hppAkhir);
  return $r;
});

// ✅ Koreksi selisih Rp: total harus sama persis seperti laporan HPP
$sumRpReal = (int)$rawData->sum('total_rp');
$diffRp    = $totalBalanceRp - $sumRpReal;

if ($diffRp !== 0 && $rawData->count() > 0) {
  $idx = $rawData->keys()->last();
  $rawData[$idx]->total_rp += $diffRp;
}

// =========================================================
// 9️⃣ GROUPING UNTUK TAMPILAN
// =========================================================
$data = $rawData
  ->filter(fn($r)=> (float)$r->stok > 0)
  ->groupBy('nama_range')
  ->map(fn($g)=>$g->groupBy('nama_gudang'));

// ✅ TOTAL bawah pakai hasil HPP (biar konsisten)
$grandStok     = round($totalBalance, 3);

// ✅ PASTI sama persis dengan laporan HPP
$grandTotalRp  = $totalBalanceRp;
@endphp

<div>
  <h1 style="text-align:center;font-weight:bold;">Laporan Stock Overview</h1>
  <p style="text-align:center;">
    Periode :
    {{ @$req->periode_from ? $helper->formatDateId(@$req->periode_from) : '-' }}
    {{ @$req->periode_to ? '- ' . $helper->formatDateId(@$req->periode_to) : '' }}
  </p>
  <br>

  <table style="border:1px solid black;border-collapse:collapse;width:100%;font-size:8px;">
    <thead>
      <tr>
        <th style="border:1px solid black;text-align:center;background:#f2f2f2;">No.</th>
        <th style="border:1px solid black;text-align:center;background:#f2f2f2;">RANGE KA</th>
        <th style="border:1px solid black;text-align:center;background:#f2f2f2;">Gudang</th>
        <th style="border:1px solid black;text-align:center;background:#f2f2f2;">Kavling</th>
        <th style="border:1px solid black;text-align:center;background:#f2f2f2;">Balance</th>
        <th style="border:1px solid black;text-align:center;background:#f2f2f2;">Total Rp</th>
      </tr>
    </thead>
    <tbody>
      @php $no=1; @endphp

      @foreach($data as $range => $gudangs)
        @php
          $rangeRows = $gudangs->flatten(1);
          if ($rangeRows->sum('stok') == 0) continue;
          $rangeRowspan = $rangeRows->count();
          $firstRangeRow = true;
        @endphp

        @foreach($gudangs as $gudang => $kavlings)
          @php
            if ($kavlings->sum('stok') == 0) continue;
            $gudangRowspan = $kavlings->count();
            $firstGudangRow = true;
          @endphp

          @foreach($kavlings as $row)
            <tr>
              @if($firstRangeRow)
                <td rowspan="{{ $rangeRowspan }}" style="border:1px solid black;text-align:center;">{{ $no++ }}</td>
                <td rowspan="{{ $rangeRowspan }}" style="border:1px solid black;text-align:center;">{{ $range }}</td>
                @php $firstRangeRow = false; @endphp
              @endif

              @if($firstGudangRow)
                <td rowspan="{{ $gudangRowspan }}" style="border:1px solid black;text-align:center;">{{ $gudang }}</td>
                @php $firstGudangRow = false; @endphp
              @endif

              <td style="border:1px solid black;text-align:center;">{{ $row->nama_kavling }}</td>

              <td style="border:1px solid black;text-align:center;{{ $isExcelExport ? "mso-number-format:'0';" : '' }}">
                @php $stokInt = (int) round((float) $row->stok); @endphp
                {{ $isExcelExport ? $stokInt : number_format($stokInt, 0, ',', '.') }}
              </td>


              <td style="border:1px solid black;text-align:center;{{ $isExcelExport ? $cellNumberStyle : '' }}">
                {{ $isExcelExport ? $fmtExportPlain($row->total_rp) : $fmtBrowser($row->total_rp) }}
              </td>
            </tr>
          @endforeach

        @endforeach
      @endforeach

      <tr style="font-weight:bold;background:#f2f2f2;">
        <td colspan="4" style="border:1px solid black;text-align:center;">TOTAL</td>
        <td style="border:1px solid black;text-align:center;{{ $isExcelExport ? "mso-number-format:'0.000';" : '' }}">
          {{ $isExcelExport ? $grandStok : rtrim(rtrim(number_format((float)$grandStok, 3, ',', '.'), '0'), ',') }}
        </td>
        <td style="border:1px solid black;text-align:center;{{ $isExcelExport ? $cellNumberStyle : '' }}">
          {{ $isExcelExport ? $fmtExportPlain($grandTotalRp) : $fmtBrowser($grandTotalRp) }}
        </td>
      </tr>

      <tr style="font-weight:bold;background:#e6ffe6;">
        <td colspan="5" style="border:1px solid black;text-align:right;">HPP</td>
        <td style="border:1px solid black;text-align:center;{{ $isExcelExport ? $cellNumberStyle : '' }}">
          {{ $isExcelExport ? $fmtExportPlain($hppAkhir) : $fmtBrowser($hppAkhir) }}
        </td>
      </tr>

    </tbody>
  </table>
</div>
