data :
{
"data": [
{
"meta_read": true,
"meta_delete": true,
"meta_update": true,
"meta_create": true,
"id": 2,
"no_so": "SO-0037",
"m_customer_id": 2,
"is_alamat": false,
"alamat": "Buduran",
"alamat_drop": null,
"no_po_customer": "4051171811",
"status": "POST",
"status_transaksi": "PROCESS",
"tgl": "01/09/2025",
"top": 7,
"is_drop": false,
"is_ppn": null,
"penerima": null,
"m_item_id": 9,
"berat": 50000,
"estimasi_total": 340000000,
"harga": 6800,
"total": 340000000,
"total_ppn": 0,
"grand_total": 340000000,
"creator_id": 1,
"editor_id": null,
"created_at": "01/09/2025 16:54",
"updated_at": "01/09/2025 16:54",
"nama_customer": "Japfa Comfeed",
"jumlah_si": 1,
"sales_invoice_id": null,
"no_si": "SJ-250903-0050",
"tgl_si": "03/09/2025",
"si_d_id": null,
"kadar_air": null,
"berat_si": "10500.00",
"harga_net": null
},
{
"meta_read": true,
"meta_delete": true,
"meta_update": true,
"meta_create": true,
"id": 2,
"no_so": "SO-0037",
"m_customer_id": 2,
"is_alamat": false,
"alamat": "Buduran",
"alamat_drop": null,
"no_po_customer": "4051171811",
"status": "POST",
"status_transaksi": "PROCESS",
"tgl": "01/09/2025",
"top": 7,
"is_drop": false,
"is_ppn": null,
"penerima": null,
"m_item_id": 9,
"berat": 50000,
"estimasi_total": 340000000,
"harga": 6800,
"total": 340000000,
"total_ppn": 0,
"grand_total": 340000000,
"creator_id": 1,
"editor_id": null,
"created_at": "01/09/2025 16:54",
"updated_at": "01/09/2025 16:54",
"nama_customer": "Japfa Comfeed",
"jumlah_si": 1,
"sales_invoice_id": null,
"no_si": "SJ-250902-0047",
"tgl_si": "02/09/2025",
"si_d_id": null,
"kadar_air": null,
"berat_si": "2500.00",
"harga_net": null
},
{
"meta_read": true,
"meta_delete": true,
"meta_update": true,
"meta_create": true,
"id": 1,
"no_so": "SO-0036",
"m_customer_id": 1,
"is_alamat": false,
"alamat": null,
"alamat_drop": "Buduran Sidoarjo",
"no_po_customer": "405123456",
"status": "POST",
"status_transaksi": "PROCESS",
"tgl": "01/09/2025",
"top": 30,
"is_drop": true,
"is_ppn": null,
"penerima": "Japfa",
"m_item_id": 9,
"berat": 100000,
"estimasi_total": 660000000,
"harga": 6600,
"total": 660000000,
"total_ppn": 0,
"grand_total": 660000000,
"creator_id": 1,
"editor_id": null,
"created_at": "01/09/2025 16:14",
"updated_at": "01/09/2025 16:15",
"nama_customer": "Seger",
"jumlah_si": 2,
"sales_invoice_id": 1,
"no_si": "SI-250901-0059",
"tgl_si": "01/09/2025",
"si_d_id": null,
"kadar_air": null,
"berat_si": "10000.00",
"harga_net": null
},
{
"meta_read": true,
"meta_delete": true,
"meta_update": true,
"meta_create": true,
"id": 1,
"no_so": "SO-0036",
"m_customer_id": 1,
"is_alamat": false,
"alamat": null,
"alamat_drop": "Buduran Sidoarjo",
"no_po_customer": "405123456",
"status": "POST",
"status_transaksi": "PROCESS",
"tgl": "01/09/2025",
"top": 30,
"is_drop": true,
"is_ppn": null,
"penerima": "Japfa",
"m_item_id": 9,
"berat": 100000,
"estimasi_total": 660000000,
"harga": 6600,
"total": 660000000,
"total_ppn": 0,
"grand_total": 660000000,
"creator_id": 1,
"editor_id": null,
"created_at": "01/09/2025 16:14",
"updated_at": "01/09/2025 16:15",
"nama_customer": "Seger",
"jumlah_si": 2,
"sales_invoice_id": 3,
"no_si": "SI-250903-0061",
"tgl_si": "03/09/2025",
"si_d_id": 2,
"kadar_air": "0.00",
"berat_si": "11000.00",
"harga_net": "6600.00"
},
{
"meta_read": true,
"meta_delete": true,
"meta_update": true,
"meta_create": true,
"id": 1,
"no_so": "SO-0036",
"m_customer_id": 1,
"is_alamat": false,
"alamat": null,
"alamat_drop": "Buduran Sidoarjo",
"no_po_customer": "405123456",
"status": "POST",
"status_transaksi": "PROCESS",
"tgl": "01/09/2025",
"top": 30,
"is_drop": true,
"is_ppn": null,
"penerima": "Japfa",
"m_item_id": 9,
"berat": 100000,
"estimasi_total": 660000000,
"harga": 6600,
"total": 660000000,
"total_ppn": 0,
"grand_total": 660000000,
"creator_id": 1,
"editor_id": null,
"created_at": "01/09/2025 16:14",
"updated_at": "01/09/2025 16:15",
"nama_customer": "Seger",
"jumlah_si": 2,
"sales_invoice_id": 1,
"no_si": "SI-250901-0059",
"tgl_si": "01/09/2025",
"si_d_id": 1,
"kadar_air": "16.00",
"berat_si": "41000.00",
"harga_net": "6600.00"
},
{
"meta_read": true,
"meta_delete": true,
"meta_update": true,
"meta_create": true,
"id": 1,
"no_so": "SO-0036",
"m_customer_id": 1,
"is_alamat": false,
"alamat": null,
"alamat_drop": "Buduran Sidoarjo",
"no_po_customer": "405123456",
"status": "POST",
"status_transaksi": "PROCESS",
"tgl": "01/09/2025",
"top": 30,
"is_drop": true,
"is_ppn": null,
"penerima": "Japfa",
"m_item_id": 9,
"berat": 100000,
"estimasi_total": 660000000,
"harga": 6600,
"total": 660000000,
"total_ppn": 0,
"grand_total": 660000000,
"creator_id": 1,
"editor_id": null,
"created_at": "01/09/2025 16:14",
"updated_at": "01/09/2025 16:15",
"nama_customer": "Seger",
"jumlah_si": 2,
"sales_invoice_id": 3,
"no_si": "SI-250903-0061",
"tgl_si": "03/09/2025",
"si_d_id": null,
"kadar_air": null,
"berat_si": "42000.00",
"harga_net": null
}
],
"total": 6,
"current_page": 1,
"per_page": 25,
"from": 1,
"to": 6,
"last_page": 1,
"has_next": false,
"prev": null,
"next": null,
"processed_time": 0.0853
}

query :
public function scopeHistoriSOBySJ($query)
{
return $query
->from("t_sales_order")
->select(
"t_sales_order.*",
"mc.nama as nama_customer",

\DB::raw(
"(SELECT COUNT(*)
FROM t_sales_invoice si2
WHERE si2.t_sales_order_id = t_sales_order.id
AND si2.status = 'POST') AS jumlah_si"
),

// gunakan data SJ jika tidak ada invoice
\DB::raw("
COALESCE(si.id, NULL) as sales_invoice_id
"),
\DB::raw("
COALESCE(si.no_si, t_surat_jalan.no_sj) as no_si
"),
\DB::raw("
COALESCE(si.tgl, t_surat_jalan.tgl) as tgl_si
"),
\DB::raw("
COALESCE(sid.id, NULL) as si_d_id
"),
\DB::raw("
COALESCE(sid.ka, NULL) as kadar_air
"),
\DB::raw("
COALESCE(sid.berat_si, t_surat_jalan.berat_kirim) as berat_si
"),
\DB::raw("
COALESCE(sid.harga_net, NULL) as harga_net
")

// gunakan data SID jika sudah ada berelasi ke invoice
)

// customer
->leftJoin("m_customer as mc", "mc.id", "=", "t_sales_order.m_customer_id")

// invoice (non-trading, status POST)
->leftJoin("t_sales_invoice as si", function ($join) {
$join->on("si.t_sales_order_id", "=", "t_sales_order.id")
->where("si.status", "=", "POST")
->where(function ($q) {
$q->where("si.is_trading", "=", false)
->orWhereNull("si.is_trading");
});
})

// surat jalan (backup kalau belum ada invoice)
->leftJoin("t_surat_jalan", function ($join) {
$join->on("t_surat_jalan.t_sales_order_id", "=", "t_sales_order.id")
->where("t_surat_jalan.status", "=", "POST");
})

// invoice detail (relasi ke SJ dan SI)
->leftJoin("t_sales_invoice_d as sid", function ($join) {
$join->on("sid.t_sales_invoice_id", "=", "si.id")
->where(function ($q) {
$q->whereColumn("sid.t_surat_jalan_id", "t_surat_jalan.id")
->orWhereNull("sid.t_surat_jalan_id");
});
})

->groupBy(
"t_sales_order.id",
"mc.nama",
"si.id",
"si.no_si",
"si.tgl",
"sid.id",
"sid.ka",
//
public function scopeGetSOForSJ($query)
{
return $query
->from("t_sales_order")
->select(
"t_sales_order.id as t_sales_order_id",
"t_sales_order.*",
"customer.*",
"item.*",

// --- Berat kirim murni dari Surat Jalan (tidak ada relasi ke SI)
\DB::raw(
"CAST(COALESCE(tsj_summary.total_berat_kirim, 0) AS INTEGER) as berat_kirim"
),

// --- Berat dari Sales Invoice hanya sebagai informasi
\DB::raw(
"CAST(COALESCE(tsi_summary.total_berat_si, 0) AS INTEGER) as berat_si_non_trading"
),

\DB::raw("
CAST(COALESCE(tsi_trading_summary.total_berat_si_trading, 0) AS INTEGER) as berat_si_trading
"),

// --- Total Berat SI (gabungan semua)
\DB::raw("
CAST(
COALESCE(tsj_summary.total_berat_kirim, 0) +
COALESCE(tsi_summary.total_berat_si, 0) +
COALESCE(tsi_trading_summary.total_berat_si_trading, 0)
AS INTEGER
) as berat_si
")

// --- Berat Outstanding (OS) hanya kurangi dengan berat kirim SJ
// \DB::raw('CAST(
// t_sales_order.berat - COALESCE(tsj_summary.total_berat_kirim, 0)
// AS INTEGER) as berat_os')
)
->leftJoin(
"m_customer as customer",
"t_sales_order.m_customer_id",
"=",
"customer.id"
)
->leftJoin(
"m_item as item",
"t_sales_order.m_item_id",
"=",
"item.id"
)

->leftJoin(
\DB::raw('(
SELECT
sj.t_sales_order_id,
SUM(sj.berat_kirim) as total_berat_kirim
FROM t_surat_jalan sj
WHERE NOT EXISTS (
SELECT 1
FROM t_sales_invoice_d sid
WHERE sid.t_surat_jalan_id = sj.id
)
GROUP BY sj.t_sales_order_id
) as tsj_summary'),
"tsj_summary.t_sales_order_id",
"=",
"t_sales_order.id"
)

// Summary Sales Invoice (SI) non trading
->leftJoin(
\DB::raw('(
SELECT
si.t_sales_order_id,
SUM(sid.berat_si) as total_berat_si
FROM t_sales_invoice_d sid
JOIN t_sales_invoice si ON si.id = sid.t_sales_invoice_id
GROUP BY si.t_sales_order_id
) as tsi_summary'),
"tsi_summary.t_sales_order_id",
"=",
"t_sales_order.id"
)

// Summary Sales Invoice (SI) trading
->leftJoin(
\DB::raw('(
SELECT
si.t_sales_order_id,
SUM(sitd.berat_si) as total_berat_si_trading
FROM t_sales_invoice_trading_d sitd
JOIN t_sales_invoice si ON si.id = sitd.t_sales_invoice_id
WHERE si.is_trading = true
GROUP BY si.t_sales_order_id
) as tsi_trading_summary'),
"tsi_trading_summary.t_sales_order_id",
"=",
"t_sales_order.id"
);

}